{% extends "base.html" %}

{% block title %}AR View - {{ art.title }}{% endblock title %}

{% block content %}
  <!-- Google Model Viewer for best AR experience -->
  <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.5.0/model-viewer.min.js"></script>

  <a href="{{ url_for('art_detail', art_id=art.id) }}" class="back-btn-ar">
    <span>‚Üê</span> Back to Art
  </a>
  
  <div id="instructions">
    ‚ú® Instructions: Rotate and zoom the 3D model. Tap "View in AR" button to place it in your space!
  </div>
  
  <div id="ar-status" class="ar-status"></div>
  
  <model-viewer
    id="artModel"
    src="{{ art.model_url | default('https://modelviewer.dev/shared-assets/models/RobotExpressive/RobotExpressive.glb') }}"
    alt="{{ art.title }}"
    ar
    ar-modes="webxr scene-viewer quick-look"
    camera-controls
    touch-action="pan-y"
    auto-rotate
    auto-rotate-delay="1000"
    rotation-per-second="30deg"
    shadow-intensity="1"
    shadow-softness="0.5"
    environment-image="neutral"
    exposure="1"
    ar-scale="auto"
    ios-src="{{ art.model_url | default('https://modelviewer.dev/shared-assets/models/RobotExpressive/RobotExpressive.glb') }}"
    camera-orbit="0deg 75deg 2.5m"
    min-camera-orbit="auto auto 1m"
    max-camera-orbit="auto auto 10m"
    camera-target="0m 0.5m 0m"
  >
    <div slot="poster" id="modelPoster" class="model-poster">
      <div class="loading-spinner"></div>
      <div class="loading-text">Loading 3D model‚Ä¶</div>
    </div>
    <button slot="ar-button" class="ar-button" id="arButton">
      <i class="fas fa-camera"></i> View in AR
    </button>
    <div id="ar-prompt" slot="ar-prompt">
      <div class="ar-prompt-content">
        <i class="fas fa-mobile-alt"></i>
        <p>Point your camera at a flat surface to place the art</p>
      </div>
    </div>
  </model-viewer>
  
  <style>
    /* AR specific styles override/addition */
    body {
      padding: 0;
      margin: 0;
      background: #f5f5f5 !important; /* Lighter background for AR view */
      display: block;
      min-height: 100vh;
    }
    main {
      padding: 0;
      max-width: none;
      margin-bottom: 0; /* Remove space for bottom nav */
    }
    
    .top-header, .bottom-nav, footer {
      display: none !important; /* Hide standard navigation while in AR viewer */
    }

    model-viewer {
      width: 100%;
      height: 100vh; /* Full screen experience */
      --poster-color: #f5f5f5;
      --progress-bar-color: #667eea;
      position: relative;
      background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
    }

    /* Model Poster (Loading State) */
    .model-poster {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      z-index: 5;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 5px solid rgba(102, 126, 234, 0.2);
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 16px;
      font-weight: 600;
      color: #667eea;
    }

    #instructions {
      position: fixed;
      top: 100px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(10px);
      color: #fff;
      padding: 12px 20px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      max-width: 80%;
      animation: fadeInDown 0.5s ease-out;
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }
    
    .back-btn-ar {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 100;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      color: #667eea;
      padding: 12px 24px;
      border-radius: 12px;
      text-decoration: none;
      font-weight: 600;
      font-size: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .back-btn-ar:hover {
        background: #fff;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        transform: translateY(-1px);
    }

    /* AR Status Indicator */
    .ar-status {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 100;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      padding: 10px 18px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      display: none;
    }

    .ar-status.show {
      display: block;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .ar-status.supported {
      color: #2ecc71;
      border-left: 4px solid #2ecc71;
    }

    .ar-status.not-supported {
      color: #e74c3c;
      border-left: 4px solid #e74c3c;
    }

    /* AR Button Styling */
    .ar-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      font-size: 18px;
      padding: 18px 36px;
      border-radius: 50px;
      font-weight: 700;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.6);
      transition: all 0.3s ease;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .ar-button:hover {
      box-shadow: 0 6px 25px rgba(102, 126, 234, 0.8);
      transform: translateY(-2px);
    }

    .ar-button:active {
      transform: scale(0.98);
    }

    .ar-button i {
      font-size: 20px;
    }

    /* AR Prompt Styling */
    #ar-prompt {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 20;
    }

    .ar-prompt-content {
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      color: white;
      padding: 20px 30px;
      border-radius: 16px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      animation: pulse 2s ease-in-out infinite;
    }

    .ar-prompt-content i {
      font-size: 40px;
      margin-bottom: 10px;
      display: block;
      color: #667eea;
    }

    .ar-prompt-content p {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.05);
        opacity: 0.9;
      }
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      #instructions {
        top: 80px;
        font-size: 12px;
        padding: 10px 16px;
        max-width: 90%;
      }

      .back-btn-ar {
        top: 15px;
        left: 15px;
        padding: 10px 18px;
        font-size: 14px;
      }

      .ar-button {
        font-size: 16px;
        padding: 14px 28px;
      }

      .ar-status {
        top: 15px;
        right: 15px;
        font-size: 12px;
        padding: 8px 14px;
      }
    }

  </style>
  
  <script>
    // ========================================
    // AR VIEWER WITH CAMERA ACCESS HANDLER
    // ========================================
    
    const arButton = document.getElementById('arButton');
    const instructions = document.getElementById('instructions');
    const modelViewer = document.getElementById('artModel');
    const modelPoster = document.getElementById('modelPoster');
    const arStatus = document.getElementById('ar-status');
    const loadingText = document.querySelector('.loading-text');

    // ========================================
    // 1. Check AR Support
    // ========================================
    function checkARSupport() {
      if (modelViewer) {
        // Check if AR is supported
        if (modelViewer.canActivateAR) {
          console.log('‚úÖ AR is supported on this device');
          showARStatus('AR Ready', 'supported');
        } else {
          console.log('‚ùå AR is not supported on this device');
          showARStatus('AR Not Available', 'not-supported');
          
          // Update instructions
          if (instructions) {
            instructions.innerHTML = '‚ö†Ô∏è AR not supported. You can still rotate and zoom the 3D model!';
          }
        }
      }
    }

    function showARStatus(message, type) {
      if (arStatus) {
        arStatus.textContent = message;
        arStatus.className = 'ar-status show ' + type;
        
        // Auto-hide after 3 seconds
        setTimeout(() => {
          arStatus.classList.remove('show');
        }, 3000);
      }
    }

    // ========================================
    // 2. Request Camera Permissions
    // ========================================
    async function requestCameraPermission() {
      try {
        console.log('üì∑ Requesting camera permission...');
        
        // Request camera access
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' } // Use rear camera
        });
        
        console.log('‚úÖ Camera permission granted');
        showARStatus('Camera Access Granted', 'supported');
        
        // Stop the stream immediately (we just needed permission)
        stream.getTracks().forEach(track => track.stop());
        
        return true;
      } catch (error) {
        console.error('‚ùå Camera permission denied:', error);
        showARStatus('Camera Access Denied', 'not-supported');
        
        alert('Camera access is required for AR features. Please grant camera permission in your browser settings.');
        return false;
      }
    }

    // ========================================
    // 3. Model Loading Events
    // ========================================
    if (modelViewer) {
      // Model loading progress
      modelViewer.addEventListener('progress', (event) => {
        const progress = event.detail.totalProgress;
        const percent = Math.round(progress * 100);
        
        if (loadingText) {
          loadingText.textContent = `Loading 3D model‚Ä¶ ${percent}%`;
        }
        
        console.log(`Loading: ${percent}%`);
      });

      // Model loaded successfully
      modelViewer.addEventListener('load', () => {
        console.log('‚úÖ 3D model loaded successfully');
        
        // Hide poster
        if (modelPoster) {
          modelPoster.style.display = 'none';
        }
        
        showARStatus('Model Loaded', 'supported');
        
        // Check AR support after model loads
        setTimeout(() => {
          checkARSupport();
        }, 500);
      });

      // Model loading error
      modelViewer.addEventListener('error', (event) => {
        console.error('‚ùå Failed to load 3D model:', event);
        showARStatus('Model Load Failed', 'not-supported');
        
        if (loadingText) {
          loadingText.textContent = 'Failed to load model. Loading fallback...';
        }
        
        // Fallback to a known working model
        setTimeout(() => {
          modelViewer.src = 'https://modelviewer.dev/shared-assets/models/RobotExpressive/RobotExpressive.glb';
        }, 2000);
      });

      // Camera controls change
      modelViewer.addEventListener('camera-change', () => {
        console.log('üì∑ Camera position changed');
      });
    }

    // ========================================
    // 4. AR Button Click Handler
    // ========================================
    if (arButton) {
      arButton.addEventListener('click', async () => {
        console.log('üéØ AR button clicked');
        
        // Hide instructions when AR is activated
        if (instructions) {
          instructions.style.display = 'none';
        }
        
        // Request camera permission before activating AR
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          const hasPermission = await requestCameraPermission();
          
          if (hasPermission) {
            console.log('‚úÖ Proceeding to AR mode');
            showARStatus('Launching AR...', 'supported');
          } else {
            console.log('‚ùå Cannot proceed without camera permission');
          }
        } else {
          console.warn('‚ö†Ô∏è getUserMedia not supported on this browser');
          showARStatus('Camera API Not Supported', 'not-supported');
        }
      });
    }

    // ========================================
    // 5. AR Session Events
    // ========================================
    if (modelViewer) {
      // AR session started
      modelViewer.addEventListener('ar-status', (event) => {
        console.log('AR Status:', event.detail.status);
        
        if (event.detail.status === 'session-started') {
          console.log('‚úÖ AR session started');
          showARStatus('AR Active', 'supported');
        } else if (event.detail.status === 'not-presenting') {
          console.log('‚ÑπÔ∏è AR session ended');
          if (instructions) instructions.style.display = 'block';
        } else if (event.detail.status === 'failed') {
          console.error('‚ùå AR session failed');
          showARStatus('AR Failed', 'not-supported');
          if (instructions) instructions.style.display = 'block';
        }
      });

      // Quick look button pressed (iOS)
      modelViewer.addEventListener('quick-look-button-tapped', () => {
        console.log('üì± Quick Look activated (iOS)');
      });
    }

    // ========================================
    // 6. Device & Browser Detection
    // ========================================
    function detectDevice() {
      const ua = navigator.userAgent;
      const isIOS = /iPad|iPhone|iPod/.test(ua);
      const isAndroid = /Android/.test(ua);
      const isMobile = isIOS || isAndroid;
      
      console.log('Device Info:', {
        iOS: isIOS,
        Android: isAndroid,
        Mobile: isMobile,
        UserAgent: ua
      });
      
      // Show device-specific instructions
      if (isIOS && instructions) {
        instructions.innerHTML = 'üì± iOS detected: Tap "View in AR" to use AR Quick Look';
      } else if (isAndroid && instructions) {
        instructions.innerHTML = 'ü§ñ Android detected: Tap "View in AR" to use Scene Viewer or WebXR';
      }
      
      return { isIOS, isAndroid, isMobile };
    }

    // ========================================
    // 7. HTTPS Check (Required for AR)
    // ========================================
    function checkHTTPS() {
      const isHTTPS = window.location.protocol === 'https:';
      const isLocalhost = window.location.hostname === 'localhost' || 
                         window.location.hostname === '127.0.0.1';
      
      if (!isHTTPS && !isLocalhost) {
        console.warn('‚ö†Ô∏è HTTPS is required for AR features in production');
        showARStatus('HTTPS Required for AR', 'not-supported');
        
        if (instructions) {
          instructions.innerHTML += '<br><small>‚ö†Ô∏è Note: AR requires HTTPS in production</small>';
        }
      } else {
        console.log('‚úÖ Secure connection established');
      }
      
      return isHTTPS || isLocalhost;
    }

    // ========================================
    // 8. Initialize on Page Load
    // ========================================
    window.addEventListener('load', () => {
      console.log('üöÄ AR Viewer initialized');
      
      // Run checks
      const device = detectDevice();
      const secureConnection = checkHTTPS();
      
      // Log model info
      if (modelViewer) {
        console.log('Model Source:', modelViewer.src);
        console.log('AR Modes:', modelViewer.arModes);
      }
    });

    // ========================================
    // 9. Error Handling
    // ========================================
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error);
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection:', event.reason);
    });

  </script>
{% endblock content %}
